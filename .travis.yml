language: csharp
solution: csharp-rest-client.sln
mono: none
sudo: required
dist: xenial
dotnet: 2.2
env:
  - VERSION=1.6.2
stages:
  - test
  - name: deploy
    if: branch = master
jobs:
  include:
    - stage: test
      script:
        - echo $VERSION
        - cd Tests/UnitTests/MessageBirdUnitTests
        - dotnet restore
        - dotnet test
        - test "$(curl -I https://globalcdn.nuget.org/packages/messagebird.$VERSION.nupkg | head -n1 | awk '{print $2}')" -eq 200 && echo "package with version $VERSION already exists" && exit 0 || echo "Packing and uploading ..."
        - echo "CONTINUING"
        - cd ../../../MessageBird
        - dotnet restore
        - dotnet build
        - dotnet pack -p:PackageID=MessageBirdStaging -c Release -p:PackageVersion=$VERSION
    - stage: deploy
      script:
        - test "$(curl -I https://globalcdn.nuget.org/packages/messagebird.$VERSION.nupkg | head -n1 | awk '{print $2}')" -eq 200 && echo "package with version $VERSION already exists" && exit 0 || echo "Packing and uploading ..."
        - cd MessageBird
        - dotnet restore
        - dotnet build
        - dotnet pack -p:PackageID=MessageBirdStaging -c Release -p:PackageVersion=$VERSION
        - dotnet nuget push MessageBirdStaging.{VERSION}.nupkg -k $STAGING_KEY -s https://apiint.nugettest.org/v3/index.json
        